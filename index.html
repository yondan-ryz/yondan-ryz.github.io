<head>
    <title>Image Classification</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.16.0/tf.min.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #imagePreview {
            max-width: 300px;
            margin: 20px 0;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .prediction {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Classification</h1>
        
        <input type="file" id="imageUpload" accept="image/*">
        <br>
        <img id="imagePreview" style="display: none;">
        <div id="output" class="result"></div>
        <div id="prediction" class="prediction"></div>
    </div>

    <script>
        let model = null;

        // Fungsi untuk memuat model
        async function loadModel() {
            try {
                // Ganti dengan path ke model Anda
                model = await tf.loadGraphModel('models/model.json');
                console.log('Model berhasil dimuat!');
                document.getElementById('output').innerHTML = 'Model berhasil dimuat! Silakan upload gambar.';
            } catch (error) {
                console.error('Error loading model:', error);
                document.getElementById('output').innerHTML = 'Error loading model: ' + error.message;
            }
        }

        // Fungsi untuk memproses gambar
        async function processImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Fungsi untuk melakukan prediksi
        async function predict(img) {
            try {
                // Konversi gambar ke tensor dengan ukuran yang sesuai (200x200)
                let tensor = tf.browser.fromPixels(img)
                    .resizeBilinear([200, 200]) // Sesuai dengan input shape model
                    .div(255.0)                 // Normalisasi nilai pixel (0-1)
                    .expandDims();              // Tambahkan dimensi batch

                // Lakukan prediksi
                const prediction = await model.predict(tensor);
                const probabilities = await prediction.data();
                
                // Bersihkan tensor
                tensor.dispose();
                prediction.dispose();

                // Mencari indeks dengan probabilitas tertinggi
                const maxProbability = Math.max(...probabilities);
                const predictedClass = probabilities.indexOf(maxProbability);

                // Mengembalikan semua probabilitas dan kelas yang diprediksi
                return {
                    probabilities: probabilities,
                    predictedClass: predictedClass,
                    confidence: maxProbability
                };
            } catch (error) {
                console.error('Error during prediction:', error);
                throw error;
            }
        }

        // Fungsi untuk memformat hasil prediksi
        function formatPrediction(result) {
            // Sesuaikan label kelas sesuai dengan model Anda
            const classLabels = ['Kelas 0', 'Kelas 1', 'Kelas 2', 'Kelas 3'];
            
            let html = '<h3>Hasil Prediksi:</h3>';
            html += `<p>Kelas yang diprediksi: ${classLabels[result.predictedClass]}</p>`;
            html += `<p>Confidence: ${(result.confidence * 100).toFixed(2)}%</p>`;
            
            html += '<h4>Probabilitas per kelas:</h4>';
            html += '<ul>';
            result.probabilities.forEach((prob, idx) => {
                html += `<li>${classLabels[idx]}: ${(prob * 100).toFixed(2)}%</li>`;
            });
            html += '</ul>';
            
            return html;
        }

        // Event listener untuk file upload
        document.getElementById('imageUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Tampilkan preview gambar
                const preview = document.getElementById('imagePreview');
                preview.style.display = 'block';
                preview.src = URL.createObjectURL(file);

                // Tunggu sampai gambar dimuat
                const img = await processImage(file);
                
                // Pastikan model sudah dimuat
                if (!model) {
                    throw new Error('Model belum dimuat');
                }

                // Lakukan prediksi
                const result = await predict(img);
                
                // Tampilkan hasil
                document.getElementById('prediction').innerHTML = formatPrediction(result);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerHTML = 'Error: ' + error.message;
            }
        });

        // Muat model saat halaman dimuat
        window.onload = loadModel;
    </script>
</body>
</html>
